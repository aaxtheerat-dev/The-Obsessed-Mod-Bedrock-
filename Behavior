{
  "format_version": 2,
  "header": {
    "name": "The Obsessed (Behavior)",
    "description": "Horror behavior pack inspired by The Obsessed",
    "uuid": "11111111-1111-1111-1111-111111111111",
    "version": [1, 0, 0],
    "min_engine_version": [1, 20, 50]
  },
  "modules": [
    {
      "type": "data",
      "uuid": "22222222-2222-2222-2222-222222222222",
      "version": [1, 0, 0]
    },
    {
      "type": "script",
      "language": "javascript",
      "uuid": "33333333-3333-3333-3333-333333333333",
      "version": [1, 0, 0],
      "entry": "scripts/main.js"
    }
  ],
  "dependencies": []
}
{
  "format_version": "1.20.50",
  "minecraft:entity": {
    "description": {
      "identifier": "the_obsessed:obsessed",
      "is_spawnable": false,
      "is_summonable": true
    },
    "components": {
      "minecraft:type_family": { "family": ["obsessed","monster"] },
      "minecraft:health": { "value": 40 },
      "minecraft:movement": { "value": 0.25 },
      "minecraft:navigation.walk": { "can_path_over_water": true },
      "minecraft:behavior.look_at_player": { "priority": 1, "look_distance": 16 },
      "minecraft:behavior.random_stroll": { "priority": 5 },
      "minecraft:physics": {},
      "minecraft:despawn": { "despawn_from_distance": {} }
    },
    "events": { "the_obsessed:vanish": { "remove": {} } }
  }
}
import { world, system } from "@minecraft/server";
import { initSanity, tickSanity } from "./sanity.js";
import { spawnTick } from "./spawn_manager.js";
import { stalkingTick } from "./stalking.js";
import { cameraTick } from "./camera_effects.js";

// Initialize sanity for players
world.afterEvents.playerSpawn.subscribe(e => initSanity(e.player));

// Run main loop every tick
system.runInterval(() => {
  for (const player of world.getPlayers()) {
    tickSanity(player);
    spawnTick(player);
    stalkingTick(player);
    cameraTick(player);
  }
}, 20);
export function initSanity(player){ player.setDynamicProperty("sanity",100); }
export function tickSanity(player){
  let sanity = player.getDynamicProperty("sanity") ?? 100;
  sanity = Math.max(0, sanity);
  player.setDynamicProperty("sanity", sanity);
}
import { world } from "@minecraft/server";
export function spawnTick(player){
  const now = world.getAbsoluteTime();
  const last = player.getDynamicProperty("lastObsessedSpawn") ?? 0;
  if(now - last < 1200) return;
  if(Math.random() < 0.002){
    const loc = player.location;
    world.spawnEntity("the_obsessed:obsessed", {
      x: loc.x + (Math.random()*16-8),
      y: loc.y,
      z: loc.z + (Math.random()*16-8)
    });
    player.setDynamicProperty("lastObsessedSpawn", now);
  }
}
import { isPlayerLookingAt } from "./look_detection.js";

export function stalkingTick(player){
  const entities = player.dimension.getEntities({ type:"the_obsessed:obsessed", location:player.location, maxDistance:18 });
  if(!entities.length) return;
  const entity = entities[0];
  let sanity = player.getDynamicProperty("sanity") ?? 100;
  sanity -= 0.6;
  player.setDynamicProperty("sanity", sanity);

  if(Math.random() < 0.1) player.playSound("obsessed.breathing",{volume:0.8});
  if(isPlayerLookingAt(player, entity)){
    const loc = player.location;
    const view = player.getViewDirection();
    if(Math.random() < 0.7){
      entity.teleport({x:loc.x - view.x*10, y:loc.y, z:loc.z - view.z*10});
    }else entity.triggerEvent("the_obsessed:vanish");
  }
}
export function isPlayerLookingAt(player, entity){
  const dir = player.getViewDirection();
  const toEntity = {
    x: entity.location.x - player.location.x,
    y: entity.location.y - player.location.y,
    z: entity.location.z - player.location.z
  };
  const mag = Math.sqrt(toEntity.x**2 + toEntity.y**2 + toEntity.z**2);
  if(mag===0) return false;
  return ((dir.x*toEntity.x + dir.y*toEntity.y + dir.z*toEntity.z)/mag) > 0.95;
}
export function cameraTick(player){
  const sanity = player.getDynamicProperty("sanity") ?? 100;
  if(sanity < 25 && Math.random() < 0.05)
    player.runCommandAsync(`camera @s shake add 0.25 0.6 positional`);
}
